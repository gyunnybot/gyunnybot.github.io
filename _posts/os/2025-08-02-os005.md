---
layout: single
title:  "멀티스레드 모델"
folder: "os"
categories:
  - operatingsystem
permalink: categories/operatingsystem/5
toc: true
toc_sticky: true
sidebar_main: true
published: true
---

## 멀티스레드란?
프로세스 내 작업을 여러 개의 스레드로 분할해 처리하는 기법 자체를 말한다. 각 스레드는 프로세스의 정적 영역의 자원(코드, 데이터, 힙)을 공유하면서 스레드 별로 고유한 스택 영역 메모리를 가진다.

멀티스레드는 프로세스 수준에서의 스레드 관리 방식을 말하며, 비슷한 이름이지만 하드웨어 멀티스레딩과는 아예 다른 분류이다. 굳이 문장을 만들자면 \'멀티스레드\' 방식으로 운영되는 프로세스 내 스레드를 \'하드웨어 멀티스레딩\' 방식을 통해 스레드 수준의 병렬 처리를 진행할 수 있다고 말할 수 있겠다.

## 커널 프로세스, 사용자 프로세스
프로세스는 커널 프로세스와 사용자 프로세스로 나뉘며, 각 메모리 영역이 구분되어 실행된다. 대부분의 애플리케이션은 사용자 프로세스로 실행되며, 운영체제 내부의 작업(예: 스케줄링, 메모리 관리)은 커널 스레드가 담당한다. 운영체제 또한 프로그램이며, 부팅(Booting) 과정을 통해 프로세스 전환 후 커널 프로세스 영역에 가장 먼저 배치된다.

한편, 사용자 프로세스가 하드디스크 입출력, 프로세스 생성과 같은 커널의 기능을 사용하려면 시스템 호출(System Call)을 통해 커널에 작업을 요청해야 한다. 이때 CPU가 사용자 모드와 커널 모드를 전환하면서 작업을 처리하는 것을 이중 모드(Dual Mode)라고 한다.

## 멀티스레드 모델
앞서 프로세스는 커널 프로세스와 사용자 프로세스로 구분한다고 했는데, 스레드 또한 커널 스레드와 사용자 스레드로 나뉜다.

사용자 스레드는 시스템 호출(System Call)을 통해 커널의 기능을 사용할 수 있는데, 사용자 스레드의 요청에 대한 커널 스레드의 대응 방식에 따라 3가지 모델로 분류할 수 있다.

먼저 사용자 스레드 모델(1 to N 모델)은 프로세스를 구성하는 여러 사용자 스레드가 단 하나의 커널 스레드와 연결된 형태다.

\'CPU의 작업 흐름 단위는 스레드\'라는 문장에서의 스레드는 컴퓨터 사양을 고려할 때 적용되는 하드웨어 스레드(용어 혼동을 방지하기 위해 이하 논리 프로세서로 작성하겠다)가 아닌, 커널 스레드 또는 프로세스를 구성하는 소프트웨어(이하 사용자) 스레드를 말한다.

그런데 실제로 논리 프로세서가 실행할 수 있는 스레드는 커널 스레드뿐이다. 사용자 프로세스 내 사용자 스레드가 자원 활용이나 입출력 같은 커널의 기능을 사용하려면 시스템 호출을 통해 커널 모드로 전환해야 하는데, 이 과정에서 결국 커널 스레드가 사용자 스레드를 대신해 논리 프로세서를 통해 실행되는 것이다.

다시 말해 사용자 스레드는 커널 스레드에 의해 간접적으로 실행되는 스레드일 뿐, 시스템 호출 등의 커널 관련 작업이 발생한다고 해서 사용자 스레드 자체가 커널 스레드로 변하는 것은 아니다.

스레드 모델 이야기로 돌아가면, 사용자 스레드 모델은 사용자 영역에서 스레드를 직접 구현하며 스레드 라이브러리를 통해 스케줄링 및 동기화 기능을 커널 없이 자체적으로 처리한다. 즉, 사용자 스레드 모델에서의 프로세스 내 스레드는 커널 모드로 전환될 필요가 없어져 커널 스레드 기반의 문맥 교환이 발생하지 않는다. 따라서, 이후 설명할 다른 모델들에 비해 프로세스가 빠르게 실행된다.

하지만 사용자 스레드 모델은 여러 사용자 스레드가 하나의 커널 스레드로만 연결되어 있기 때문에 프로세스 내 스레드가 여러 개 존재하더라도(멀티스레드) 논리 프로세서 입장에서는 하나의 커널 스레드만 실행 중인 것처럼 보인다. 따라서 멀티코어 환경이 마련되어도 스레드 수준의 병렬 처리가 불가능하다(물론 명령어 수준 병렬 처리 기법은 가능하다).

또한 하나의 스레드가 블로킹 시스템 호출을 수행하는 동안, 같은 프로세스 내의 다른 스레드도 함께 블로킹되어 성능 저하가 발생할 수 있다.

커널 스레드 모델(1 to 1 모델)은 커널이 멀티스레드를 지원하는 방식으로 사용자 스레드와 커널 스레드가 1:1로 연결된다. 이는 사실상 각각의 사용자 스레드가 커널 스레드에게 작업을 위임하는 방식이라고 할 수 있다.

멀티코어 환경에서 여러 개의 CPU(또는 코어) 전체를 효율적으로 사용할 수 있으나, 논리 프로세서보다 커널 스레드가 많아질 경우 잦은 문맥 교환 오버헤드가 발생해 사용자 스레드 모델보다 느리게 작동하게 된다.

멀티레벨 스레드 모델(M to N 모델)은 사용자 스레드 모델과 커널 스레드 모델을 혼합한 방식으로, 멀티레벨 스레드 모델에서는 커널 스레드의 개수가 사용자 스레드보다 작거나 같도록 유지하여, 사용자가 적합한 실행 환경을 임의로 설정할 수 있다.