---
layout: single
title:  "ShutdownHook을 활용한 자원 정리"
folder: "java"
categories:
  - java
permalink: categories/java/java007
tags: JAVA
toc: true
toc_sticky: true
sidebar_main: true
published: true
---

## JAVA 소켓 프로그래밍
여러 컴퓨터 간에 정보나 데이터를 교환하는 기술을 <span style="color: rgb(3, 150, 150); font-weight: bold;">`네트워킹(Networking)`</span>이라고 하며, 일반적으로 네트워크를 통한 프로세스 간 통신(IPC)은 소켓을 활용하기 때문에 <span style="color: rgb(3, 150, 150); font-weight: bold;">`소켓 프로그래밍(Socket Programming)`</span>으로도 불립니다.

정보를 요청한 클라이언트는 서버의 (주소, 포트 번호) 쌍으로 연결될 수 있는 <span style="color: rgb(3, 150, 150); font-weight: bold;">`소켓(Socket)`</span>과 데이터를 주고 받을 수 있는 <span style="color: rgb(3, 150, 150); font-weight: bold;">`스트림(Stream)`</span>을 생성한 후 서버와 통신할 수 있습니다.

```java
private static final int PORT = 12345; //서버의 포트 번호를 12345로 가정

Socket socket = new Socket("localhost", PORT); //(localhost, PORT)와 연결될 수 있는 클라이언트 소켓 생성

DataInputStream input = new DataInputStream(socket.getInputStream());
DataOutputStream output = new DataOutputStream(socket.getOutputStream());
```

요청에 대한 응답을 제공하는 서버는 먼저 <span style="color: rgb(3, 150, 150); font-weight: bold;">`서버 소켓(Server Socket)`</span>이라는 특별한 소켓을 생성합니다. 서버 소켓은 클라이언트가 서버와의 통신을 걸어올 때 초기 연결을 실행하며, 커널 내 <span style="color: rgb(3, 150, 150); font-weight: bold;">`OS backlog queue`</span>에 클라이언트와 서버의 TCP/IP 연결 정보를 저장하는 역할을 합니다.

이후 서버 소켓은 <span style="color: rgb(3, 150, 150); font-weight: bold;">`accept()`</span>를 통해 본인이 가지고 있는 포트 번호를 기반으로 새로운 소켓을 생성한 후 선택된 클라이언트 소켓과의 연결을 돕습니다.

정리하면 클라이언트와 서버의 연결 자체는 서버 소켓이 담당하지만, 클라이언트와의 실제 통신은 서버 소켓에 의해 생성된 소켓과 진행됩니다.

```java
private static final int PORT = 12345; //서버의 포트 번호를 12345로 가정

ServerSocket serverSocket = new ServerSocket(PORT); //소켓과의 연결을 위한 서버 소켓 생성
Socket socket = serverSocket.accept(); //서버 소켓으로부터 생성된 포트. 실제 통신은 socket으로 진행
```

## ShutdownHook을 활용한 자원 정리
자바는 프로세스가 종료될 때 자원 정리나 로그 기록과 같은 종료 작업을 마무리 할 수 있는 <span style="color: rgb(3, 150, 150); font-weight: bold;">`셧다운 훅(ShutdownHook)`</span> 기능을 지원합니다. `Runtime.getRuntime().addShutdownHook()` 경로를 통해 등록할 수 있으며, 셧다운이 발생했을 때 처리할 작업과 스레드를 인자로 등록하면 프로세스를 종료하기 전에 관련 작업을 종료하거나 자원을 회수할 수 있습니다.

```java
//ShutdownHook 등록
ShutdownHook shutdownHook = new ShutdownHook(serverSocket);
Runtime.getRuntime().addShutdownHook(new Thread(shutdownHook, "shutdown"));
```

```java
static class ShutdownHook implements Runnable {
        private final ServerSocket serverSocket; //서버 소켓
        private final SessionManager sessionManager; //클라이언트 소켓을 관리하는 세션

        public ShutdownHook(ServerSocket serverSocket, SessionManager sessionManager) {
            this.serverSocket = serverSocket;
            this.sessionManager = sessionManager;
        }

        @Override
        public void run() {
            log("ShutdownHook 실행");

            try {
                sessionManager.closeAll(); //클라이언트 소켓 자원 전체 정리
                serverSocket.close(); //서버 소켓 자원 정리
                Thread.sleep(1000);
            } catch (Exception e) {
                e.printStackTrace();
                System.out.println("e = " + e);

                throw new RuntimeException(e);
            }
        }
    }
```